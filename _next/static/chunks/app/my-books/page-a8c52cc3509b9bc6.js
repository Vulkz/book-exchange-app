(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[232],{8486:function(e,s,a){Promise.resolve().then(a.bind(a,4646))},4646:function(e,s,a){"use strict";a.r(s),a.d(s,{default:function(){return z}});var t=a(7437),r=a(2265),i=a(9376),o=a(5452),l=a(6128),n=a(9703),c=a(173),d=a(2869),m=a(5186),x=a(6815),u=a(6818),h=a(3647),g=a(6070),p=a(1769),v=a(2489),j=a(9397);function f(e){let{isOpen:s,onClose:a,onSuccess:i,book:n}=e,{user:c}=(0,l.a)(),f=(0,o.createClientComponentClient)(),[b,N]=(0,r.useState)({title:"",author:"",description:"",category:""}),[y,w]=(0,r.useState)(""),[k,_]=(0,r.useState)([""]),[C,E]=(0,r.useState)(""),[S,z]=(0,r.useState)(!1),[L,A]=(0,r.useState)({});(0,r.useEffect)(()=>{if(n&&s){console.log("Loading book data for editing:",n),N({title:n.title||"",author:n.author||"",description:n.description||"",category:n.category||""}),w(n.image_url||""),console.log("Meeting locations from book:",n.meeting_locations);let e=[];n.meeting_locations&&Array.isArray(n.meeting_locations)&&(e=n.meeting_locations.map(e=>"string"==typeof e?e:e.location||"").filter(e=>e.trim())),0===e.length&&(e=[""]),console.log("Setting meeting locations:",e),_(e)}},[n,s]);let Z=e=>{let{name:s,value:a}=e.target;N(e=>({...e,[s]:a})),L[s]&&A(e=>({...e,[s]:""}))},q=(e,s)=>{N(a=>({...a,[e]:s})),L[e]&&A(s=>({...s,[e]:""}))},F=e=>{_(s=>s.filter((s,a)=>a!==e))},I=()=>{let e={};return b.title.trim()||(e.title="T\xedtulo \xe9 obrigat\xf3rio"),b.author.trim()||(e.author="Autor \xe9 obrigat\xf3rio"),b.description.trim()||(e.description="Descri\xe7\xe3o \xe9 obrigat\xf3ria"),b.category||(e.category="Categoria \xe9 obrigat\xf3ria"),0===k.filter(e=>e.trim()).length&&(e.locations="Adicione pelo menos um local de encontro"),A(e),0===Object.keys(e).length},M=async e=>{var s,a,t,r;if(e.preventDefault(),I()){z(!0);try{if(console.log("Verificando autentica\xe7\xe3o..."),!c)throw Error("Usu\xe1rio n\xe3o autenticado");let{data:{session:e},error:a}=await f.auth.getSession();if(a||!e)throw Error("Sess\xe3o expirada. Fa\xe7a logout e login novamente.");console.log("Usu\xe1rio autenticado:",{userId:c.id,email:c.email,sessionValid:!!e}),console.log("Updating book:",n.id);let{error:t}=await f.from("books").update({title:b.title.trim(),author:b.author.trim(),description:b.description.trim(),category:b.category||"Literatura",image_url:y.trim()||null}).eq("id",n.id);if(t)throw t;console.log("Verificando propriedade do livro...");let{data:r,error:o}=await f.from("books").select("owner_id").eq("id",n.id).single();if(o||!r||r.owner_id!==c.id)throw Error("Voc\xea n\xe3o tem permiss\xe3o para editar este livro");let l=k.filter(e=>e.trim());console.log("Locais v\xe1lidos para salvar:",l);let{data:d}=await f.from("meeting_locations").select("location").eq("book_id",n.id),m=(null==d?void 0:d.map(e=>e.location))||[];if(console.log("Locais existentes:",m),l.length===m.length&&l.every(e=>m.includes(e)))console.log("Locais n\xe3o mudaram, mantendo os existentes");else{console.log("Locais mudaram, atualizando...");let{error:e}=await f.from("meeting_locations").delete().eq("book_id",n.id);if(e)throw console.error("Erro ao deletar locais existentes:",e),Error("Erro ao deletar locais existentes: ".concat(e.message));if(l.length>0){let e=l.map(e=>({book_id:n.id,location:e.trim()}));console.log("Inserindo novos locais:",e);let{error:a}=await f.from("meeting_locations").insert(e);if(a){if(console.error("Erro detalhado ao inserir locais:",a),null===(s=a.message)||void 0===s?void 0:s.includes("row-level security"))throw Error("Erro de permiss\xe3o: Execute novamente o script fix_meeting_locations_rls_v2.sql no Supabase");throw Error("Erro ao inserir locais: ".concat(a.message))}console.log("Locais inseridos com sucesso!")}}console.log("Livro atualizado com sucesso"),alert("Livro atualizado com sucesso!"),i()}catch(s){console.error("Erro detalhado ao atualizar livro:",s);let e=s.message||"Erro desconhecido ao atualizar livro";(null===(a=s.message)||void 0===a?void 0:a.includes("row-level security"))?e="Erro de permiss\xe3o: Execute o script fix_meeting_locations_rls_v2.sql no Supabase para corrigir as pol\xedticas de seguran\xe7a.":(null===(t=s.message)||void 0===t?void 0:t.includes("network"))?e="Erro de conex\xe3o. Verifique sua internet e tente novamente.":(null===(r=s.message)||void 0===r?void 0:r.includes("authentication"))&&(e="Sess\xe3o expirada. Fa\xe7a logout e login novamente."),A({general:e}),alert("❌ ".concat(e))}finally{z(!1)}}};return s?(0,t.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:(0,t.jsxs)(g.Zb,{className:"w-full max-w-md max-h-[90vh] overflow-y-auto",children:[(0,t.jsx)(g.Ol,{children:(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsxs)(g.ll,{className:"flex items-center space-x-2",children:[(0,t.jsx)(p.Z,{className:"h-5 w-5"}),(0,t.jsx)("span",{children:"Editar Livro"})]}),(0,t.jsx)(d.z,{variant:"ghost",size:"sm",onClick:a,children:(0,t.jsx)(v.Z,{className:"h-4 w-4"})})]})}),(0,t.jsx)(g.aY,{children:(0,t.jsxs)("form",{onSubmit:M,className:"space-y-4",children:[L.general&&(0,t.jsx)("div",{className:"text-sm text-red-500 bg-red-50 p-2 rounded",children:L.general}),(0,t.jsxs)("div",{children:[(0,t.jsx)(x._,{htmlFor:"title",children:"T\xedtulo *"}),(0,t.jsx)(m.I,{id:"title",name:"title",value:b.title,onChange:Z,className:L.title?"border-red-500":"",placeholder:"Ex: Dom Casmurro",required:!0}),L.title&&(0,t.jsx)("p",{className:"text-sm text-red-500 mt-1",children:L.title})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)(x._,{htmlFor:"author",children:"Autor *"}),(0,t.jsx)(m.I,{id:"author",name:"author",value:b.author,onChange:Z,className:L.author?"border-red-500":"",placeholder:"Ex: Machado de Assis",required:!0}),L.author&&(0,t.jsx)("p",{className:"text-sm text-red-500 mt-1",children:L.author})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)(x._,{htmlFor:"category",children:"Categoria *"}),(0,t.jsxs)(h.Ph,{onValueChange:e=>q("category",e),value:b.category,children:[(0,t.jsx)(h.i4,{className:L.category?"border-red-500":"",children:(0,t.jsx)(h.ki,{placeholder:"Selecione uma categoria"})}),(0,t.jsx)(h.Bw,{children:["Literatura Brasileira","Literatura Estrangeira","Fic\xe7\xe3o Cient\xedfica","Fantasia","Romance","Suspense/Thriller","Hist\xf3ria","Biografia","Autoajuda","Tecnologia","Ci\xeancia","Psicologia","Filosofia","Arte","Culin\xe1ria","Esportes","Infantil","Jovem Adulto","Educa\xe7\xe3o","Neg\xf3cios","Outro"].map(e=>(0,t.jsx)(h.Ql,{value:e,children:e},e))})]}),L.category&&(0,t.jsx)("p",{className:"text-sm text-red-500 mt-1",children:L.category})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)(x._,{htmlFor:"imageUrl",children:"URL da Imagem (opcional)"}),(0,t.jsx)(m.I,{id:"imageUrl",name:"imageUrl",type:"url",value:y,onChange:e=>w(e.target.value),placeholder:"Ex: https://exemplo.com/imagem-do-livro.jpg"}),(0,t.jsx)("p",{className:"text-sm text-gray-500 mt-1",children:"Cole o link de uma imagem da capa do livro (opcional)"}),y&&(0,t.jsx)("div",{className:"mt-2",children:(0,t.jsx)("img",{src:y,alt:"Preview",className:"w-20 h-28 object-cover rounded border",onError:()=>w("")})})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)(x._,{htmlFor:"description",children:"Descri\xe7\xe3o *"}),(0,t.jsx)(u.g,{id:"description",name:"description",value:b.description,onChange:Z,className:L.description?"border-red-500":"",placeholder:"Descreva o livro, seu estado, etc.",rows:3,required:!0}),L.description&&(0,t.jsx)("p",{className:"text-sm text-red-500 mt-1",children:L.description})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)(x._,{children:"Locais de Encontro *"}),(0,t.jsxs)("div",{className:"space-y-2",children:[k.map((e,s)=>(0,t.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,t.jsx)(m.I,{value:e,onChange:e=>{let a=[...k];a[s]=e.target.value,_(a)},placeholder:"Ex: Shopping Center Norte",className:"flex-1"}),(0,t.jsx)(d.z,{type:"button",variant:"outline",size:"sm",onClick:()=>F(s),disabled:1===k.length,children:(0,t.jsx)(v.Z,{className:"h-4 w-4"})})]},s)),(0,t.jsxs)("div",{className:"flex space-x-2",children:[(0,t.jsx)(m.I,{value:C,onChange:e=>E(e.target.value),placeholder:"Adicionar novo local",className:"flex-1"}),(0,t.jsx)(d.z,{type:"button",variant:"outline",onClick:()=>{C.trim()&&(_(e=>[...e,C.trim()]),E(""))},children:(0,t.jsx)(j.Z,{className:"h-4 w-4"})})]})]}),L.locations&&(0,t.jsx)("p",{className:"text-sm text-red-500 mt-1",children:L.locations})]}),(0,t.jsxs)("div",{className:"flex space-x-2 pt-4",children:[(0,t.jsx)(d.z,{type:"button",variant:"outline",onClick:a,className:"flex-1",disabled:S,children:"Cancelar"}),(0,t.jsx)(d.z,{type:"submit",disabled:S,className:"flex-1",children:S?"Salvando...":"Salvar Altera\xe7\xf5es"})]})]})})]})}):null}var b=a(5974),N=a(7992),y=a(2718),w=a(9205);let k=(0,w.Z)("Heart",[["path",{d:"M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z",key:"c3ymky"}]]),_=(0,w.Z)("Pencil",[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}],["path",{d:"m15 5 4 4",key:"1mk7zo"}]]),C=(0,w.Z)("Trash2",[["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6",key:"4alrt4"}],["path",{d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2",key:"v07s0e"}],["line",{x1:"10",x2:"10",y1:"11",y2:"17",key:"1uufr5"}],["line",{x1:"14",x2:"14",y1:"11",y2:"17",key:"xtxkd"}]]);var E=a(3774),S=a(3145);function z(){let{user:e,loading:s,signOut:a}=(0,l.a)(),[m,x]=(0,r.useState)([]),[u,h]=(0,r.useState)(!0),[v,w]=(0,r.useState)(!1),[z,L]=(0,r.useState)(!1),[A,Z]=(0,r.useState)(null),[q,F]=(0,r.useState)(null),I=(0,i.useRouter)(),M=(0,o.createClientComponentClient)();(0,r.useEffect)(()=>{s||(e?V(e.id):h(!1))},[e,s]);let V=async e=>{try{console.log("Loading books for user:",e);let{data:s,error:a}=await M.from("books").select("\n          id,\n          title,\n          author,\n          description,\n          category,\n          availability_status,\n          image_url,\n          created_at,\n          meeting_locations (\n            id,\n            location\n          )\n        ").eq("owner_id",e).order("created_at",{ascending:!1});if(console.log("Books query result:",{booksData:s,error:a}),a){console.error("Error loading books:",a),(0,N.Am)({title:"Erro",description:"Erro ao carregar seus livros",variant:"destructive"});return}console.log("Setting books:",s),x(s||[])}catch(e){console.error("Error:",e),(0,N.Am)({title:"Erro",description:"Erro inesperado ao carregar livros",variant:"destructive"})}finally{h(!1)}},O=async()=>{await a(),I.push("/")},T=async e=>{if(confirm("Tem certeza que deseja excluir este livro?")){F(e);try{let{error:s}=await M.from("books").delete().eq("id",e);if(s){console.error("Error deleting book:",s),(0,N.Am)({title:"Erro",description:"Erro ao excluir livro",variant:"destructive"});return}(0,N.Am)({title:"Sucesso!",description:"Livro exclu\xeddo com sucesso"}),x(s=>s.filter(s=>s.id!==e))}catch(e){console.error("Error:",e),(0,N.Am)({title:"Erro",description:"Erro inesperado ao excluir",variant:"destructive"})}finally{F(null)}}},U=e=>{Z(e),L(!0)},B=e=>{switch(e){case"available":return"bg-green-100 text-green-800";case"requested":return"bg-yellow-100 text-yellow-800";case"exchanged":return"bg-blue-100 text-blue-800";default:return"bg-gray-100 text-gray-800"}},D=e=>{switch(e){case"available":return"Dispon\xedvel";case"requested":return"Com Solicita\xe7\xf5es";case"exchanged":return"Trocado";default:return e}};return s||u?(0,t.jsx)("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center",children:(0,t.jsxs)("div",{className:"text-center",children:[(0,t.jsx)(p.Z,{className:"h-12 w-12 text-blue-600 animate-pulse mx-auto mb-4"}),(0,t.jsx)("p",{className:"text-gray-600",children:"Carregando..."})]})}):e?(0,t.jsxs)("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100",children:[(0,t.jsx)(n.W,{userId:e.id,onAddBook:()=>w(!0),onLogout:O}),(0,t.jsxs)("main",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:[(0,t.jsxs)("div",{className:"flex justify-between items-center mb-8",children:[(0,t.jsx)("h1",{className:"text-3xl font-bold",children:"Meus Livros"}),(0,t.jsxs)(d.z,{onClick:()=>w(!0),className:"flex items-center gap-2",children:[(0,t.jsx)(j.Z,{className:"h-4 w-4"}),"Adicionar Livro"]})]}),0===m.length?(0,t.jsxs)("div",{className:"text-center py-16",children:[(0,t.jsx)("div",{className:"mb-6",children:(0,t.jsx)(p.Z,{className:"mx-auto h-16 w-16 text-gray-400"})}),(0,t.jsx)("h3",{className:"text-2xl font-medium text-gray-900 mb-3",children:"Sua biblioteca est\xe1 vazia"}),(0,t.jsx)("p",{className:"text-gray-500 mb-6 max-w-md mx-auto",children:"Comece adicionando seus livros favoritos e conecte-se com outros leitores da comunidade!"}),(0,t.jsxs)(d.z,{onClick:()=>w(!0),size:"lg",className:"mb-6",children:[(0,t.jsx)(j.Z,{className:"h-5 w-5 mr-2"}),"Adicionar Meu Primeiro Livro"]}),(0,t.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 max-w-2xl mx-auto text-sm text-gray-500",children:[(0,t.jsxs)("div",{className:"text-center",children:[(0,t.jsx)("div",{className:"bg-blue-50 rounded-full w-12 h-12 flex items-center justify-center mx-auto mb-2",children:(0,t.jsx)(p.Z,{className:"h-6 w-6 text-blue-600"})}),(0,t.jsx)("p",{className:"font-medium",children:"Adicione seus livros"}),(0,t.jsx)("p",{className:"text-xs",children:"Cadastre livros que voc\xea tem"})]}),(0,t.jsxs)("div",{className:"text-center",children:[(0,t.jsx)("div",{className:"bg-green-50 rounded-full w-12 h-12 flex items-center justify-center mx-auto mb-2",children:(0,t.jsx)(y.Z,{className:"h-6 w-6 text-green-600"})}),(0,t.jsx)("p",{className:"font-medium",children:"Receba solicita\xe7\xf5es"}),(0,t.jsx)("p",{className:"text-xs",children:"Outros usu\xe1rios podem pedir emprestado"})]}),(0,t.jsxs)("div",{className:"text-center",children:[(0,t.jsx)("div",{className:"bg-purple-50 rounded-full w-12 h-12 flex items-center justify-center mx-auto mb-2",children:(0,t.jsx)(k,{className:"h-6 w-6 text-purple-600"})}),(0,t.jsx)("p",{className:"font-medium",children:"Compartilhe conhecimento"}),(0,t.jsx)("p",{className:"text-xs",children:"Ajude a comunidade a crescer"})]})]})]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("div",{className:"mb-4 text-gray-600",children:[m.length," ",1===m.length?"livro cadastrado":"livros cadastrados"]}),(0,t.jsx)("div",{className:"grid gap-6 md:grid-cols-2 lg:grid-cols-3",children:m.map(e=>(0,t.jsxs)(g.Zb,{className:"overflow-hidden",children:[(0,t.jsx)("div",{className:"aspect-[3/4] relative",children:e.image_url?(0,t.jsx)(S.default,{src:e.image_url,alt:e.title,fill:!0,className:"object-cover"}):(0,t.jsx)("div",{className:"w-full h-full bg-gray-200 flex items-center justify-center",children:(0,t.jsx)("svg",{className:"h-12 w-12 text-gray-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"})})})}),(0,t.jsxs)(g.aY,{className:"p-4",children:[(0,t.jsxs)("div",{className:"flex justify-between items-start mb-2",children:[(0,t.jsx)(b.C,{className:"".concat(B(e.availability_status)," border-0"),children:D(e.availability_status)}),(0,t.jsxs)("div",{className:"flex gap-1",children:[(0,t.jsx)(d.z,{variant:"ghost",size:"sm",className:"p-1 h-8 w-8",title:"Editar livro",onClick:()=>U(e),children:(0,t.jsx)(_,{className:"h-4 w-4"})}),(0,t.jsx)(d.z,{variant:"ghost",size:"sm",className:"p-1 h-8 w-8 text-red-600 hover:text-red-700 hover:bg-red-50",title:"Excluir livro",disabled:q===e.id,onClick:()=>T(e.id),children:(0,t.jsx)(C,{className:"h-4 w-4"})})]})]}),(0,t.jsx)("h3",{className:"font-semibold text-lg mb-1 line-clamp-2",children:e.title}),(0,t.jsxs)("p",{className:"text-gray-600 mb-2",children:["por ",e.author]}),e.category&&(0,t.jsx)(b.C,{variant:"outline",className:"mb-3",children:e.category}),(0,t.jsx)("p",{className:"text-sm text-gray-600 mb-3 line-clamp-2",children:e.description}),e.meeting_locations&&e.meeting_locations.length>0&&(0,t.jsxs)("div",{className:"space-y-1",children:[(0,t.jsxs)("p",{className:"text-xs font-medium text-gray-500 flex items-center gap-1",children:[(0,t.jsx)(E.Z,{className:"h-3 w-3"}),"Locais de encontro:"]}),e.meeting_locations.slice(0,2).map(e=>(0,t.jsxs)("p",{className:"text-xs text-gray-600 pl-4",children:["• ",e.location]},e.id)),e.meeting_locations.length>2&&(0,t.jsxs)("p",{className:"text-xs text-gray-500 pl-4",children:["+",e.meeting_locations.length-2," outros..."]})]})]})]},e.id))})]})]}),v&&(0,t.jsx)(c.k,{isOpen:v,onClose:()=>w(!1),onSuccess:()=>{w(!1),e&&V(e.id)}}),z&&A&&(0,t.jsx)(f,{isOpen:z,onClose:()=>{L(!1),Z(null)},onSuccess:()=>{L(!1),Z(null),e&&V(e.id)},book:A})]}):(0,t.jsx)("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center",children:(0,t.jsx)("div",{className:"text-center",children:(0,t.jsxs)("div",{className:"bg-white p-8 rounded-lg shadow-lg max-w-md",children:[(0,t.jsx)(p.Z,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),(0,t.jsx)("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Acesso Restrito"}),(0,t.jsx)("p",{className:"text-gray-600 mb-4",children:"Voc\xea precisa estar logado para ver seus livros."}),(0,t.jsx)(d.z,{onClick:()=>I.push("/"),className:"w-full",children:"Fazer Login"})]})})})}}},function(e){e.O(0,[452,614,145,789,971,117,744],function(){return e(e.s=8486)}),_N_E=e.O()}]);