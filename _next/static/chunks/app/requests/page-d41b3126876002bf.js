(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[608],{8229:function(e,s,a){Promise.resolve().then(a.bind(a,1914))},1914:function(e,s,a){"use strict";a.r(s),a.d(s,{default:function(){return q}});var t=a(7437),r=a(2265),i=a(9376),o=a(5452),l=a(6128),n=a(9703),c=a(173),d=a(6070),u=a(2869),m=a(5974),x=a(2339),g=a(7992),h=a(9205);let v=(0,h.Z)("Clock",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["polyline",{points:"12 6 12 12 16 14",key:"68esgv"}]]),p=(0,h.Z)("CircleCheckBig",[["path",{d:"M21.801 10A10 10 0 1 1 17 3.335",key:"yps3ct"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]]),f=(0,h.Z)("CircleX",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]]);var b=a(3417),j=a(1769);let y=(0,h.Z)("Users",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["path",{d:"M22 21v-2a4 4 0 0 0-3-3.87",key:"kshegd"}],["path",{d:"M16 3.13a4 4 0 0 1 0 7.75",key:"1da9ce"}]]);var N=a(4743);let w=(0,h.Z)("Inbox",[["polyline",{points:"22 12 16 12 14 15 10 15 8 12 2 12",key:"o97t9d"}],["path",{d:"M5.45 5.11 2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z",key:"oot6mr"}]]);var D=a(2369),_=a(1047),k=a(3145);function q(){let{user:e,loading:s,signOut:a}=(0,l.a)(),[h,q]=(0,r.useState)([]),[E,C]=(0,r.useState)([]),[S,A]=(0,r.useState)(!0),[R,Z]=(0,r.useState)(!1),[z,L]=(0,r.useState)(null),[P,B]=(0,r.useState)("recebidas"),M=(0,i.useRouter)(),O=(0,o.createClientComponentClient)();(0,r.useEffect)(()=>{"enviadas"===new URLSearchParams(window.location.search).get("tab")&&B("enviadas")},[]),(0,r.useEffect)(()=>{s||(e?F():A(!1))},[e,s]),(0,r.useEffect)(()=>{if(!(null==e?void 0:e.id))return;let s=O.channel("requests_realtime").on("postgres_changes",{event:"*",schema:"public",table:"requests",filter:"or(requester_id.eq.".concat(e.id,",owner_id.eq.").concat(e.id,")")},e=>{console.log("Real-time request change:",e),F()}).subscribe();return()=>{O.removeChannel(s)}},[null==e?void 0:e.id]);let F=async()=>{try{console.log("\uD83D\uDD04 Carregando todas as solicita\xe7\xf5es para usu\xe1rio:",null==e?void 0:e.id),A(!0),await Promise.all([U(),V()]),console.log("✅ Solicita\xe7\xf5es carregadas com sucesso!"),console.log("\uD83D\uDCCA Estado atual:",{receivedCount:h.length,sentCount:E.length})}catch(e){console.error("Error loading requests:",e),(0,g.Am)({title:"Erro",description:"Erro inesperado ao carregar solicita\xe7\xf5es",variant:"destructive"})}finally{A(!1)}},U=async()=>{try{console.log("Loading received requests for user:",null==e?void 0:e.id);let{data:s,error:a}=await O.from("requests").select("\n          id,\n          status,\n          message,\n          created_at,\n          book_id,\n          requester_id,\n          owner_id\n        ").eq("owner_id",null==e?void 0:e.id).order("created_at",{ascending:!1});if(console.log("Received requests query result:",{requestsData:s,error:a}),a){console.error("Error loading received requests:",a),(0,g.Am)({title:"Erro",description:"Erro ao carregar solicita\xe7\xf5es recebidas: "+a.message,variant:"destructive"});return}(s||[]).map(e=>e.id);let t=(s||[]).map(e=>e.book_id),r=(s||[]).map(e=>e.requester_id),i=[];if(t.length>0){let{data:e}=await O.from("books").select("id, title, author, image_url").in("id",t);i=e||[]}let o=[];if(r.length>0){let{data:e}=await O.from("profiles").select("id, display_name, email").in("id",r);o=e||[]}let l=(s||[]).map(e=>{let s=i.find(s=>s.id===e.book_id)||{},a=o.find(s=>s.id===e.requester_id)||{};return{id:e.id,status:e.status,message:e.message,created_at:e.created_at,book:s,requester:a}});console.log("Mapped received requests:",l),q(l)}catch(e){console.error("Error loading received requests:",e),(0,g.Am)({title:"Erro",description:"Erro inesperado ao carregar solicita\xe7\xf5es recebidas",variant:"destructive"})}},V=async()=>{try{if(console.log("\uD83D\uDCE4 Loading SENT requests for user:",null==e?void 0:e.id),!(null==e?void 0:e.id)){console.error("❌ Sem user ID para buscar solicita\xe7\xf5es enviadas");return}let{data:s,error:a}=await O.from("requests").select("\n          id,\n          status,\n          message,\n          created_at,\n          book_id,\n          owner_id,\n          requester_id\n        ").eq("requester_id",e.id).order("created_at",{ascending:!1});if(console.log("\uD83D\uDCE4 Sent requests RAW query result:",{requestsData:s,error:a,totalFound:(null==s?void 0:s.length)||0,userId:e.id}),a){console.error("❌ Error loading sent requests:",a),(0,g.Am)({title:"Erro",description:"Erro ao carregar solicita\xe7\xf5es enviadas: "+a.message,variant:"destructive"});return}if(!s||0===s.length){console.log("\uD83D\uDCE4 Nenhuma solicita\xe7\xe3o enviada encontrada para o usu\xe1rio:",e.id),C([]);return}console.log("\uD83D\uDCE4 Found",s.length,"sent requests, processing...");let t=[...new Set(s.map(e=>e.book_id).filter(Boolean))],r=[...new Set(s.map(e=>e.owner_id).filter(Boolean))];console.log("\uD83D\uDCE4 Fetching related data:",{bookIds:t,ownerIds:r});let i=[];if(t.length>0){let{data:e,error:s}=await O.from("books").select("id, title, author, image_url").in("id",t);s?console.error("❌ Error fetching books:",s):(i=e||[],console.log("\uD83D\uDCDA Books fetched:",i.length))}let o=[];if(r.length>0){let{data:e,error:s}=await O.from("profiles").select("id, display_name, email").in("id",r);s?console.error("❌ Error fetching owners:",s):(o=e||[],console.log("\uD83D\uDC65 Owners fetched:",o.length))}let l=s.map(e=>{let s=i.find(s=>s.id===e.book_id)||{id:e.book_id,title:"Livro n\xe3o encontrado",author:"Desconhecido",image_url:null},a=o.find(s=>s.id===e.owner_id)||{id:e.owner_id,display_name:"Usu\xe1rio n\xe3o encontrado",email:""};return{id:e.id,status:e.status,message:e.message,created_at:e.created_at,book:s,owner:a}});console.log("\uD83D\uDCE4 Final mapped SENT requests:",l),console.log("\uD83D\uDCE4 Atualizando estado setSentRequests com:",l.length,"itens"),C(l),console.log("\uD83D\uDCE4 Estado atualizado! Aguarde pr\xf3ximo render...")}catch(e){console.error("❌ Error loading sent requests:",e),(0,g.Am)({title:"Erro",description:"Erro inesperado ao carregar solicita\xe7\xf5es enviadas",variant:"destructive"})}},I=async()=>{await a(),M.push("/")},Q=async(e,s,a)=>{L(e);try{let{data:i}=await O.from("requests").select("\n          requester_id,\n          books!inner (\n            title\n          )\n        ").eq("id",e).single(),{error:o}=await O.from("requests").update({status:s}).eq("id",e);if(o){console.error("Error responding to request:",o),(0,g.Am)({title:"Erro",description:"Erro ao responder solicita\xe7\xe3o",variant:"destructive"});return}if(i)try{var t,r;let e={user_id:i.requester_id,type:"aceita"===s?"request_accepted":"request_rejected",title:"Solicita\xe7\xe3o ".concat(s),message:'Sua solicita\xe7\xe3o do livro "'.concat(null===(r=i.books)||void 0===r?void 0:null===(t=r[0])||void 0===t?void 0:t.title,'" foi ').concat(s,". ").concat(a?"Resposta: "+a:"")};console.log("Criando notifica\xe7\xe3o de resposta...",e);let{error:o}=await O.from("notifications").insert(e);o?console.error("Erro ao criar notifica\xe7\xe3o:",o):console.log("Notifica\xe7\xe3o de resposta criada com sucesso!")}catch(e){console.error("Erro inesperado ao criar notifica\xe7\xe3o:",e)}(0,g.Am)({title:"Sucesso!",description:"Solicita\xe7\xe3o ".concat("aceita"===s?"aceita":"recusada"," com sucesso")}),await F()}catch(e){console.error("Error:",e),(0,g.Am)({title:"Erro",description:"Erro inesperado ao responder",variant:"destructive"})}finally{L(null)}},Y=e=>{switch(e){case"pendente":return"bg-yellow-100 text-yellow-800";case"aceita":return"bg-green-100 text-green-800";case"recusada":return"bg-red-100 text-red-800";default:return"bg-gray-100 text-gray-800"}},H=e=>{switch(e){case"pendente":return"Pendente";case"aceita":return"Aceita";case"recusada":return"Recusada";default:return e}},T=e=>{switch(e){case"pendente":return(0,t.jsx)(v,{className:"h-4 w-4"});case"aceita":return(0,t.jsx)(p,{className:"h-4 w-4"});case"recusada":return(0,t.jsx)(f,{className:"h-4 w-4"});default:return(0,t.jsx)(b.Z,{className:"h-4 w-4"})}};return(console.log("\uD83C\uDFA8 RENDER - Estado atual:",{receivedRequests:h.length,sentRequests:E.length,activeTab:P,loading:S,authLoading:s,sentRequestsArray:E}),s||S)?(0,t.jsx)("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center",children:(0,t.jsxs)("div",{className:"text-center",children:[(0,t.jsx)(j.Z,{className:"h-12 w-12 text-blue-600 animate-pulse mx-auto mb-4"}),(0,t.jsx)("p",{className:"text-gray-600",children:"Carregando..."})]})}):e?(0,t.jsxs)("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100",children:[(0,t.jsx)(n.W,{userId:e.id,onAddBook:()=>Z(!0),onLogout:I}),(0,t.jsxs)("main",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:[(0,t.jsx)("div",{className:"flex justify-between items-center mb-8",children:(0,t.jsx)("h1",{className:"text-3xl font-bold",children:"Minhas Solicita\xe7\xf5es"})}),(0,t.jsxs)(x.mQ,{value:"enviadas"===P?"enviadas":"recebidas",onValueChange:e=>B(e),className:"w-full",children:[(0,t.jsxs)(x.dr,{className:"grid w-full grid-cols-2",children:[(0,t.jsxs)(x.SP,{value:"recebidas",className:"flex items-center gap-2",children:[(0,t.jsx)(y,{className:"h-4 w-4"}),"Recebidas (",h.length,")"]}),(0,t.jsxs)(x.SP,{value:"enviadas",className:"flex items-center gap-2",children:[(0,t.jsx)(N.Z,{className:"h-4 w-4"}),"Enviadas (",E.length,")"]})]}),(0,t.jsxs)(x.nU,{value:"recebidas",className:"mt-6",children:[(0,t.jsxs)("div",{className:"mb-4",children:[(0,t.jsx)("h2",{className:"text-xl font-semibold text-gray-800 mb-2",children:"Solicita\xe7\xf5es Recebidas"}),(0,t.jsx)("p",{className:"text-gray-600",children:"Pessoas que querem pegar seus livros emprestados"})]}),0===h.length?(0,t.jsxs)("div",{className:"text-center py-16",children:[(0,t.jsx)("div",{className:"mb-6",children:(0,t.jsx)(w,{className:"mx-auto h-16 w-16 text-gray-400"})}),(0,t.jsx)("h3",{className:"text-xl font-medium text-gray-900 mb-2",children:"Nenhuma solicita\xe7\xe3o recebida"}),(0,t.jsx)("p",{className:"text-gray-500 mb-6 max-w-md mx-auto",children:"Quando algu\xe9m solicitar empr\xe9stimo dos seus livros, as solicita\xe7\xf5es aparecer\xe3o aqui."}),(0,t.jsxs)("div",{className:"space-y-2 text-sm text-gray-400",children:[(0,t.jsx)("p",{children:"\uD83D\uDCA1 Dica: Adicione mais livros para receber mais solicita\xe7\xf5es"}),(0,t.jsx)("p",{children:"\uD83D\uDCDA Compartilhe seus livros favoritos com outros leitores"})]})]}):(0,t.jsx)("div",{className:"space-y-6",children:h.map(e=>{var s,a,r,i,o;return(0,t.jsxs)(d.Zb,{className:"overflow-hidden",children:[(0,t.jsx)(d.Ol,{className:"pb-3",children:(0,t.jsxs)("div",{className:"flex items-start justify-between",children:[(0,t.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,t.jsx)("div",{className:"flex-shrink-0",children:(0,t.jsx)(D.Z,{className:"h-10 w-10 text-gray-400 bg-gray-100 rounded-full p-2"})}),(0,t.jsxs)("div",{children:[(0,t.jsx)("h3",{className:"font-semibold text-lg",children:null===(s=e.requester)||void 0===s?void 0:s.display_name}),(0,t.jsx)("p",{className:"text-gray-600 text-sm",children:null===(a=e.requester)||void 0===a?void 0:a.email})]})]}),(0,t.jsxs)(m.C,{className:"".concat(Y(e.status)," border-0 flex items-center gap-1"),children:[T(e.status),H(e.status)]})]})}),(0,t.jsxs)(d.aY,{className:"space-y-4",children:[(0,t.jsxs)("div",{className:"flex items-center space-x-4 p-3 bg-gray-50 rounded-lg",children:[(null===(r=e.book)||void 0===r?void 0:r.image_url)?(0,t.jsx)(k.default,{src:e.book.image_url,alt:e.book.title,width:60,height:80,className:"object-cover rounded"}):(0,t.jsx)("div",{className:"w-15 h-20 bg-gray-200 rounded flex items-center justify-center",children:(0,t.jsx)(j.Z,{className:"h-6 w-6 text-gray-400"})}),(0,t.jsxs)("div",{children:[(0,t.jsx)("h4",{className:"font-medium",children:null===(i=e.book)||void 0===i?void 0:i.title}),(0,t.jsxs)("p",{className:"text-gray-600 text-sm",children:["por ",null===(o=e.book)||void 0===o?void 0:o.author]})]})]}),(0,t.jsx)("div",{children:(0,t.jsx)("p",{className:"text-gray-700",children:e.message})}),"pendente"===e.status&&(0,t.jsxs)("div",{className:"flex space-x-3 pt-3",children:[(0,t.jsxs)(u.z,{onClick:()=>Q(e.id,"aceita","Solicita\xe7\xe3o aceita! Vamos combinar os detalhes."),disabled:z===e.id,className:"flex-1 bg-green-600 hover:bg-green-700",children:[(0,t.jsx)(p,{className:"h-4 w-4 mr-2"}),"Aceitar"]}),(0,t.jsxs)(u.z,{onClick:()=>Q(e.id,"recusada","Obrigado pelo interesse, mas n\xe3o posso emprestar no momento."),disabled:z===e.id,variant:"destructive",className:"flex-1",children:[(0,t.jsx)(f,{className:"h-4 w-4 mr-2"}),"Recusar"]})]}),(0,t.jsxs)("div",{className:"flex items-center text-xs text-gray-500 pt-2 border-t",children:[(0,t.jsx)(_.Z,{className:"h-3 w-3 mr-1"}),"Solicitado em ",new Date(e.created_at).toLocaleDateString("pt-BR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"})]})]})]},e.id)})})]}),(0,t.jsxs)(x.nU,{value:"enviadas",className:"mt-6",children:[(0,t.jsxs)("div",{className:"mb-4",children:[(0,t.jsx)("h2",{className:"text-xl font-semibold text-gray-800 mb-2",children:"Solicita\xe7\xf5es Enviadas"}),(0,t.jsx)("p",{className:"text-gray-600",children:"Livros que voc\xea solicitou de outros usu\xe1rios"})]}),0===E.length?(0,t.jsxs)("div",{className:"text-center py-16",children:[(0,t.jsx)("div",{className:"mb-6",children:(0,t.jsx)(N.Z,{className:"mx-auto h-16 w-16 text-gray-400"})}),(0,t.jsx)("h3",{className:"text-xl font-medium text-gray-900 mb-2",children:"Nenhuma solicita\xe7\xe3o enviada"}),(0,t.jsx)("p",{className:"text-gray-500 mb-6 max-w-md mx-auto",children:"Voc\xea ainda n\xe3o solicitou nenhum livro. Explore a biblioteca e encontre livros interessantes!"}),(0,t.jsxs)("div",{className:"space-y-2 text-sm text-gray-400",children:[(0,t.jsx)("p",{children:"\uD83D\uDCA1 Dica: Navegue pela p\xe1gina inicial para descobrir novos livros"}),(0,t.jsx)("p",{children:"\uD83D\uDCD6 Solicite livros que deseja ler"})]})]}):(0,t.jsx)("div",{className:"space-y-6",children:E.map(e=>{var s,a,r,i,o;return(0,t.jsxs)(d.Zb,{className:"overflow-hidden",children:[(0,t.jsx)(d.Ol,{className:"pb-3",children:(0,t.jsxs)("div",{className:"flex items-start justify-between",children:[(0,t.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,t.jsx)("div",{className:"flex-shrink-0",children:(0,t.jsx)(D.Z,{className:"h-10 w-10 text-gray-400 bg-gray-100 rounded-full p-2"})}),(0,t.jsxs)("div",{children:[(0,t.jsxs)("h3",{className:"font-semibold text-lg",children:["Para: ",null===(s=e.owner)||void 0===s?void 0:s.display_name]}),(0,t.jsx)("p",{className:"text-gray-600 text-sm",children:null===(a=e.owner)||void 0===a?void 0:a.email})]})]}),(0,t.jsxs)(m.C,{className:"".concat(Y(e.status)," border-0 flex items-center gap-1"),children:[T(e.status),H(e.status)]})]})}),(0,t.jsxs)(d.aY,{className:"space-y-4",children:[(0,t.jsxs)("div",{className:"flex items-center space-x-4 p-3 bg-gray-50 rounded-lg",children:[(null===(r=e.book)||void 0===r?void 0:r.image_url)?(0,t.jsx)(k.default,{src:e.book.image_url,alt:e.book.title,width:60,height:80,className:"object-cover rounded"}):(0,t.jsx)("div",{className:"w-15 h-20 bg-gray-200 rounded flex items-center justify-center",children:(0,t.jsx)(j.Z,{className:"h-6 w-6 text-gray-400"})}),(0,t.jsxs)("div",{children:[(0,t.jsx)("h4",{className:"font-medium",children:null===(i=e.book)||void 0===i?void 0:i.title}),(0,t.jsxs)("p",{className:"text-gray-600 text-sm",children:["por ",null===(o=e.book)||void 0===o?void 0:o.author]})]})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("p",{className:"text-sm font-medium text-gray-900 mb-1",children:"Sua mensagem:"}),(0,t.jsx)("p",{className:"text-gray-700",children:e.message})]}),(0,t.jsxs)("div",{className:"flex items-center text-xs text-gray-500 pt-2 border-t",children:[(0,t.jsx)(_.Z,{className:"h-3 w-3 mr-1"}),"Solicitado em ",new Date(e.created_at).toLocaleDateString("pt-BR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"})]})]})]},e.id)})})]})]})]}),R&&(0,t.jsx)(c.k,{isOpen:R,onClose:()=>Z(!1),onSuccess:()=>Z(!1)})]}):(0,t.jsx)("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center",children:(0,t.jsx)("div",{className:"text-center",children:(0,t.jsxs)("div",{className:"bg-white p-8 rounded-lg shadow-lg max-w-md",children:[(0,t.jsx)(b.Z,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),(0,t.jsx)("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Acesso Restrito"}),(0,t.jsx)("p",{className:"text-gray-600 mb-4",children:"Voc\xea precisa estar logado para ver suas solicita\xe7\xf5es."}),(0,t.jsx)(u.z,{onClick:()=>M.push("/"),className:"w-full",children:"Fazer Login"})]})})})}},2339:function(e,s,a){"use strict";a.d(s,{SP:function(){return n},dr:function(){return l},mQ:function(){return o},nU:function(){return c}});var t=a(7437);a(2265);var r=a(9707),i=a(4508);function o(e){let{className:s,...a}=e;return(0,t.jsx)(r.fC,{"data-slot":"tabs",className:(0,i.cn)("flex flex-col gap-2",s),...a})}function l(e){let{className:s,...a}=e;return(0,t.jsx)(r.aV,{"data-slot":"tabs-list",className:(0,i.cn)("bg-muted text-muted-foreground inline-flex h-9 w-fit items-center justify-center rounded-lg p-[3px]",s),...a})}function n(e){let{className:s,...a}=e;return(0,t.jsx)(r.xz,{"data-slot":"tabs-trigger",className:(0,i.cn)("data-[state=active]:bg-background dark:data-[state=active]:text-foreground focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:outline-ring dark:data-[state=active]:border-input dark:data-[state=active]:bg-input/30 text-foreground dark:text-muted-foreground inline-flex h-[calc(100%-1px)] flex-1 items-center justify-center gap-1.5 rounded-md border border-transparent px-2 py-1 text-sm font-medium whitespace-nowrap transition-[color,box-shadow] focus-visible:ring-[3px] focus-visible:outline-1 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:shadow-sm [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",s),...a})}function c(e){let{className:s,...a}=e;return(0,t.jsx)(r.VY,{"data-slot":"tabs-content",className:(0,i.cn)("flex-1 outline-none",s),...a})}}},function(e){e.O(0,[452,614,145,590,789,971,117,744],function(){return e(e.s=8229)}),_N_E=e.O()}]);